name: Deploy to Dev Environment

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to dev (blue.flippi.ai)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 157.245.142.145
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            echo "🚀 Deploying develop branch to blue.flippi.ai..."
            
            # Navigate to dev environment
            cd /var/www/blue.flippi.ai
            
            # Pull latest code
            echo "📥 Pulling latest code..."
            git fetch origin
            git checkout develop
            git pull origin develop
            
            # Backend deployment
            echo "🔧 Updating backend..."
            cd backend
            npm install --production
            
            # Frontend deployment  
            echo "🎨 Building frontend..."
            cd ../mobile-app
            npm install
            npx expo export:web
            
            # Restart services
            echo "🔄 Restarting services..."
            pm2 restart dev-backend
            pm2 restart dev-frontend
            
            # Health check
            echo "🏥 Checking health..."
            sleep 5
            curl -f https://blue.flippi.ai/health || exit 1
            
            echo "✅ Dev deployment complete!"
            pm2 status | grep -E "(dev-backend|dev-frontend)"

      - name: Create deployment issue if failed
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '🚨 Dev Deployment Failed',
              body: `## Deployment Failure Report
              
**Environment**: Development (blue.flippi.ai)
**Branch**: develop
**Commit**: ${context.sha}
**Time**: ${new Date().toISOString()}

### Quick Debug:
\`\`\`bash
ssh root@157.245.142.145
cd /var/www/blue.flippi.ai
git status
pm2 logs dev-backend
pm2 logs dev-frontend
\`\`\`

**For AI Coder**: Please investigate and fix the dev deployment failure.`,
              labels: ['bug', 'deployment-failure', 'env:dev', 'automated', 'p1-critical']
            });